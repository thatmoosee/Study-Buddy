<!DOCTYPE html>
<html>
<head>
    <title>Forgot Password â€” Study Buddy</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <main style="text-align:center; margin-top:50px;">
        <h1>Forgot Password</h1>
        <p>Enter your email to generate a password reset link.</p>

        <form id="forgotPasswordForm">
            <input type="email" id="email" placeholder="School Email (.edu)" required>
            <br><br>
            <button type="submit">Generate Reset Link</button>
        </form>

        <p><a href="login.html">Back to Login</a></p>

        <p id="error" style="color:red;"></p>
        <p id="success" style="color:green;"></p>

        <div id="resetLinkContainer" style="display:none; margin-top:20px; padding:20px; background-color:#f0f0f0; border-radius:8px;">
            <h3>Your Password Reset Link:</h3>
            <p style="font-size:12px; color:#666;">Click the link below or copy it to reset your password. This link expires in 15 minutes.</p>
            <a id="resetLink" href="#" target="_blank" style="word-break:break-all; color:#007bff; font-weight:bold;"></a>
            <br><br>
            <button id="copyButton" style="margin-top:10px; padding:8px 16px; background-color:#28a745; color:white; border:none; border-radius:4px; cursor:pointer;">Copy Link</button>
        </div>
    </main>

    <script>
        document.getElementById("forgotPasswordForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = document.getElementById("email").value.trim();
            const errorBox = document.getElementById("error");
            const successBox = document.getElementById("success");
            const resetLinkContainer = document.getElementById("resetLinkContainer");
            errorBox.textContent = "";
            successBox.textContent = "";
            resetLinkContainer.style.display = "none";

            const res = await fetch("/api/auth/forgot-password", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email })
            });

            const data = await res.json();

            if (data.success) {
                if (data.token) {
                    // Display the reset link
                    const resetUrl = `${window.location.origin}/reset_password.html?token=${data.token}`;
                    const resetLink = document.getElementById("resetLink");
                    resetLink.href = resetUrl;
                    resetLink.textContent = resetUrl;
                    resetLinkContainer.style.display = "block";

                    successBox.textContent = "Password reset link generated! Use the link below to reset your password.";
                    document.getElementById("forgotPasswordForm").reset();
                } else {
                    // No token returned (user doesn't exist, but don't reveal this)
                    successBox.textContent = data.message;
                    document.getElementById("forgotPasswordForm").reset();
                }
            } else {
                errorBox.textContent = data.error;
            }
        });

        // Copy link functionality
        document.getElementById("copyButton").addEventListener("click", () => {
            const resetLink = document.getElementById("resetLink").textContent;
            navigator.clipboard.writeText(resetLink).then(() => {
                const copyButton = document.getElementById("copyButton");
                const originalText = copyButton.textContent;
                copyButton.textContent = "Copied!";
                setTimeout(() => {
                    copyButton.textContent = originalText;
                }, 2000);
            });
        });
    </script>
</body>
</html>
